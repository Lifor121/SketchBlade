<?xml version="1.0" encoding="utf-8" ?>
<UserControl x:Class="SketchBlade.Views.BattleView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:SketchBlade.Views"
             xmlns:models="clr-namespace:SketchBlade.Models"
             xmlns:converters="clr-namespace:SketchBlade.Helpers.Converters"
             xmlns:system="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">
    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:HealthToVisibilityConverter x:Key="HealthToVisibilityConverter"/>
        <converters:MultiBoolToVisibilityConverter x:Key="MultiBoolToVisibilityConverter"/>
        <converters:BoolToTextConverter x:Key="BoolToTextConverter"/>
        <converters:EnemyToSelectedConverter x:Key="EnemyToSelectedConverter"/>
        <converters:AllEnemiesDefeatedConverter x:Key="AllEnemiesDefeatedConverter"/>
        <converters:CommandParameterConverter x:Key="CommandParameterConverter"/>
        <converters:TranslationConverter x:Key="TranslationConverter"/>
        <converters:ImagePathToBitmapConverter x:Key="ImagePathToBitmapConverter"/>
        <converters:AttackingCharacterConverter x:Key="AttackingCharacterConverter"/>
        <converters:CharacterComparisonConverter x:Key="CharacterComparisonConverter"/>
        
        <ControlTemplate x:Key="HealthBarTemplate" TargetType="ProgressBar">
            <Border BorderBrush="Gray" BorderThickness="1" Background="#222222">
                <Border x:Name="PART_Indicator" 
                        HorizontalAlignment="Left" 
                        Background="#4CAF50" 
                        Margin="0" />
            </Border>
        </ControlTemplate>
        
        <SolidColorBrush x:Key="PrimaryBrush" Color="#4CAF50"/>
        <SolidColorBrush x:Key="SecondaryBrush" Color="#FF5722"/>
        <SolidColorBrush x:Key="BackgroundBrush" Color="#FAFAFA"/>
        <SolidColorBrush x:Key="SurfaceBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="BorderBrush" Color="#DDDDDD"/>
        <SolidColorBrush x:Key="AccentBrush" Color="#2196F3"/>
        <SolidColorBrush x:Key="CriticalHitBrush" Color="#FF0000"/>
        
        <!-- Вернем анимационную поддержку -->
        <Storyboard x:Key="ShakeAnimation">
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.X)"
                From="-5" To="5" Duration="0:0:0.05" AutoReverse="True" RepeatBehavior="3x"/>
        </Storyboard>
        
        <!-- Добавим анимации победы и поражения -->
        <Storyboard x:Key="VictoryAnimation">
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                From="1" To="1.2" Duration="0:0:0.5" AutoReverse="True" RepeatBehavior="2x"/>
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                From="1" To="1.2" Duration="0:0:0.5" AutoReverse="True" RepeatBehavior="2x"/>
        </Storyboard>
        
        <Storyboard x:Key="DefeatAnimation">
            <DoubleAnimation
                Storyboard.TargetProperty="Opacity"
                From="1" To="0.2" Duration="0:0:1.5"/>
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)"
                From="0" To="50" Duration="0:0:1.5"/>
        </Storyboard>
        
        <Style x:Key="AttackAnimationStyle" TargetType="Image">
            <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <TransformGroup>
                        <ScaleTransform/>
                        <SkewTransform/>
                        <RotateTransform/>
                        <TranslateTransform X="0" Y="0"/>
                    </TransformGroup>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10">
            <Button x:Name="BackToMapButton" Content="{Binding Source='Common.Back', Converter={StaticResource TranslationConverter}}" Width="120" Height="30" 
                   Command="{Binding NavigateCommand}"
                   CommandParameter="WorldMapView"/>
            <TextBlock Text="{Binding Source='Battle.Title', Converter={StaticResource TranslationConverter}}" FontSize="24" FontWeight="Bold" Margin="20,0,0,0" VerticalAlignment="Center"/>
            <TextBlock Text="{Binding BattleStatus}" FontSize="18" Margin="20,0,0,0" VerticalAlignment="Center" 
                      Foreground="{StaticResource PrimaryBrush}"/>
        </StackPanel>
        
        <!-- Main Battle Area -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Player Character -->
            <Border x:Name="PlayerBorder" Grid.Column="0" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1" 
                   Margin="20" Padding="15" 
                   CornerRadius="5" HorizontalAlignment="Center" VerticalAlignment="Center">
                <Border.Background>
                    <SolidColorBrush Color="#FAFAFA"/>
                </Border.Background>
                <Border.RenderTransform>
                    <TransformGroup>
                        <ScaleTransform/>
                        <SkewTransform/>
                        <RotateTransform/>
                        <TranslateTransform X="0" Y="0"/>
                    </TransformGroup>
                </Border.RenderTransform>
                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Triggers>
                            <!-- Анимация получения урона игроком (только когда враг атакует и игрок НЕ атакует) -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding IsEnemyAttacking}" Value="True"/>
                                    <Condition Binding="{Binding IsPlayerAttacking}" Value="False"/>
                                </MultiDataTrigger.Conditions>
                                <MultiDataTrigger.EnterActions>
                                    <!-- Сначала останавливаем анимацию атаки, если она запущена -->
                                    <StopStoryboard BeginStoryboardName="PlayerAttackStoryboard"/>
                                    <BeginStoryboard Name="PlayerHitStoryboard">
                                        <Storyboard>
                                            <DoubleAnimation 
                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[3].(TranslateTransform.X)" 
                                                From="0" To="-20" Duration="0:0:0.05" 
                                                AutoReverse="True" RepeatBehavior="3x"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </MultiDataTrigger.EnterActions>
                                <MultiDataTrigger.ExitActions>
                                    <StopStoryboard BeginStoryboardName="PlayerHitStoryboard"/>
                                </MultiDataTrigger.ExitActions>
                            </MultiDataTrigger>
                            <!-- Анимация атаки игрока (приоритет выше, поэтому идет после) -->
                            <DataTrigger Binding="{Binding IsPlayerAttacking}" Value="True">
                                <DataTrigger.EnterActions>
                                    <!-- Сначала останавливаем анимацию дрожания, если она запущена -->
                                    <StopStoryboard BeginStoryboardName="PlayerHitStoryboard"/>
                                    <BeginStoryboard Name="PlayerAttackStoryboard">
                                        <Storyboard>
                                            <DoubleAnimationUsingKeyFrames 
                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[3].(TranslateTransform.X)">
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.0" Value="0"/>
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.2" Value="150">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <PowerEase Power="2" EasingMode="EaseOut"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.3" Value="200">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <PowerEase Power="2" EasingMode="EaseOut"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.5" Value="0">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <PowerEase Power="2" EasingMode="EaseIn"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                            </DoubleAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.EnterActions>
                                <DataTrigger.ExitActions>
                                    <StopStoryboard BeginStoryboardName="PlayerAttackStoryboard"/>
                                </DataTrigger.ExitActions>
                            </DataTrigger>
                            
                            <!-- Цветовые эффекты зелий для игрока -->
                            <!-- Эффект зелья лечения - розовый -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding PlayerCharacter.HasActiveColorEffect}" Value="True"/>
                                    <Condition Binding="{Binding PlayerCharacter.CurrentColorEffect}" Value="Healing"/>
                                </MultiDataTrigger.Conditions>
                                <MultiDataTrigger.EnterActions>
                                    <BeginStoryboard Name="PlayerHealingEffectStoryboard">
                                        <Storyboard>
                                            <ColorAnimation 
                                                Storyboard.TargetProperty="Background.(SolidColorBrush.Color)"
                                                From="#FAFAFA" To="#FFB6C1" Duration="0:0:0.5" 
                                                AutoReverse="True" RepeatBehavior="Forever"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </MultiDataTrigger.EnterActions>
                                <MultiDataTrigger.ExitActions>
                                    <StopStoryboard BeginStoryboardName="PlayerHealingEffectStoryboard"/>
                                </MultiDataTrigger.ExitActions>
                            </MultiDataTrigger>
                            
                            <!-- Эффект зелья ярости - красный -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding PlayerCharacter.HasActiveColorEffect}" Value="True"/>
                                    <Condition Binding="{Binding PlayerCharacter.CurrentColorEffect}" Value="Rage"/>
                                </MultiDataTrigger.Conditions>
                                <MultiDataTrigger.EnterActions>
                                    <BeginStoryboard Name="PlayerRageEffectStoryboard">
                                        <Storyboard>
                                            <ColorAnimation 
                                                Storyboard.TargetProperty="Background.(SolidColorBrush.Color)"
                                                From="#FAFAFA" To="#FFB6B6" Duration="0:0:0.8" 
                                                AutoReverse="True" RepeatBehavior="Forever"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </MultiDataTrigger.EnterActions>
                                <MultiDataTrigger.ExitActions>
                                    <StopStoryboard BeginStoryboardName="PlayerRageEffectStoryboard"/>
                                </MultiDataTrigger.ExitActions>
                            </MultiDataTrigger>
                            
                            <!-- Эффект зелья неуязвимости - синий -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding PlayerCharacter.HasActiveColorEffect}" Value="True"/>
                                    <Condition Binding="{Binding PlayerCharacter.CurrentColorEffect}" Value="Defense"/>
                                </MultiDataTrigger.Conditions>
                                <MultiDataTrigger.EnterActions>
                                    <BeginStoryboard Name="PlayerDefenseEffectStoryboard">
                                        <Storyboard>
                                            <ColorAnimation 
                                                Storyboard.TargetProperty="Background.(SolidColorBrush.Color)"
                                                From="#FAFAFA" To="#B6D7FF" Duration="0:0:0.8" 
                                                AutoReverse="True" RepeatBehavior="Forever"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </MultiDataTrigger.EnterActions>
                                <MultiDataTrigger.ExitActions>
                                    <StopStoryboard BeginStoryboardName="PlayerDefenseEffectStoryboard"/>
                                </MultiDataTrigger.ExitActions>
                            </MultiDataTrigger>
                            
                            <!-- Эффект отравления для игрока - зеленоватый -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding PlayerCharacter.HasActiveColorEffect}" Value="True"/>
                                    <Condition Binding="{Binding PlayerCharacter.CurrentColorEffect}" Value="Poison"/>
                                </MultiDataTrigger.Conditions>
                                <MultiDataTrigger.EnterActions>
                                    <BeginStoryboard Name="PlayerPoisonEffectStoryboard">
                                        <Storyboard>
                                            <ColorAnimation 
                                                Storyboard.TargetProperty="Background.(SolidColorBrush.Color)"
                                                From="#FAFAFA" To="#B6FFB6" Duration="0:0:0.5" 
                                                AutoReverse="True"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </MultiDataTrigger.EnterActions>
                                <MultiDataTrigger.ExitActions>
                                    <StopStoryboard BeginStoryboardName="PlayerPoisonEffectStoryboard"/>
                                </MultiDataTrigger.ExitActions>
                            </MultiDataTrigger>
                            
                            <!-- Анимация использования предметов - бросок -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding IsUsingItem}" Value="True"/>
                                    <Condition Binding="{Binding CurrentItemAnimationType}" Value="Throwing"/>
                                </MultiDataTrigger.Conditions>
                                <MultiDataTrigger.EnterActions>
                                    <BeginStoryboard Name="PlayerThrowingStoryboard">
                                        <Storyboard>
                                            <!-- Анимация замаха и броска -->
                                            <DoubleAnimationUsingKeyFrames 
                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[3].(TranslateTransform.X)">
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.0" Value="0"/>
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.2" Value="-30">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <PowerEase Power="2" EasingMode="EaseOut"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.4" Value="80">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <PowerEase Power="3" EasingMode="EaseIn"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.6" Value="0">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <PowerEase Power="2" EasingMode="EaseOut"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                            </DoubleAnimationUsingKeyFrames>
                                            <!-- Поворот при броске -->
                                            <DoubleAnimationUsingKeyFrames 
                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[2].(RotateTransform.Angle)">
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.0" Value="0"/>
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.2" Value="-5"/>
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.4" Value="10"/>
                                                <EasingDoubleKeyFrame KeyTime="0:0:0.6" Value="0"/>
                                            </DoubleAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </MultiDataTrigger.EnterActions>
                                <MultiDataTrigger.ExitActions>
                                    <StopStoryboard BeginStoryboardName="PlayerThrowingStoryboard"/>
                                </MultiDataTrigger.ExitActions>
                            </MultiDataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <StackPanel>
                    <TextBlock Text="{Binding PlayerCharacter.TranslatedName}" FontSize="20" FontWeight="Bold" 
                             HorizontalAlignment="Center" Margin="0,0,0,10"/>
                    <Grid>
                        <Image Source="{Binding PlayerCharacter.ImagePath, Converter={StaticResource ImagePathToBitmapConverter}}" Width="150" Height="150" Margin="0,0,0,10"/>
                    </Grid>
                    <Grid Margin="10,5,10,5">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- Показываем характеристики персонажа -->
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="{Binding Source='Battle.Health', Converter={StaticResource TranslationConverter}}" Margin="0,0,10,5"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding PlayerHealth}" Margin="0,0,0,5"/>
                        
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="{Binding Source='Battle.Attack', Converter={StaticResource TranslationConverter}}" Margin="0,0,10,5"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding PlayerDamage}" Margin="0,0,0,5"/>
                        
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="{Binding Source='Battle.Defense', Converter={StaticResource TranslationConverter}}" Margin="0,0,10,5"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding PlayerDefense}" Margin="0,0,0,5"/>
                    </Grid>
                </StackPanel>
            </Border>
            
            <!-- Battle Status -->
            <Border Grid.Column="1" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1" 
                   Background="{StaticResource BackgroundBrush}" Padding="15" CornerRadius="5" 
                   VerticalAlignment="Center" HorizontalAlignment="Center" MinWidth="180">
                <StackPanel>
                    <TextBlock Text="VS" FontSize="32" FontWeight="Bold" HorizontalAlignment="Center" 
                             Foreground="{StaticResource AccentBrush}" Margin="0,0,0,10"/>
                    
                    <!-- Сообщение о выборе цели для предметов -->
                    <TextBlock Text="{Binding TargetSelectionMessage}" TextWrapping="Wrap" Margin="0,0,0,10" 
                             HorizontalAlignment="Center" FontWeight="Bold" FontSize="16"
                             Foreground="Orange" 
                             Visibility="{Binding IsTargetSelectionMode, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    
                    <!-- Кнопка отмены выбора цели -->
                    <Button Content="Отменить" Width="80" Height="30" Margin="0,0,0,10"
                           Command="{Binding CancelTargetSelectionCommand}"
                           Background="#FF5722" Foreground="White" FontWeight="Bold"
                           Visibility="{Binding IsTargetSelectionMode, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    
                    <TextBlock Text="{Binding TurnMessage}" TextWrapping="Wrap" Margin="0,0,0,10" 
                             HorizontalAlignment="Center"/>
                    
                    <!-- Damage message with animation -->
                    <Grid>
                        <TextBlock Text="{Binding DamageMessage}" TextWrapping="Wrap" Margin="0,5,0,10" 
                                 HorizontalAlignment="Center" Foreground="Red" FontWeight="Bold">
                            <TextBlock.Visibility>
                                <MultiBinding Converter="{StaticResource MultiBoolToVisibilityConverter}">
                                    <Binding Path="DamageMessage" Converter="{StaticResource BoolToVisibilityConverter}" ConverterParameter="hasContent"/>
                                    <Binding Path="GameState.Settings.ShowCombatDamageNumbers"/>
                                </MultiBinding>
                            </TextBlock.Visibility>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <!-- Возвращаем анимацию критического удара -->
                                        <DataTrigger Binding="{Binding IsCriticalHit}" Value="True">
                                            <DataTrigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation 
                                                            Storyboard.TargetProperty="FontSize" 
                                                            From="16" To="22" Duration="0:0:0.2" 
                                                            AutoReverse="True" RepeatBehavior="2x"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.EnterActions>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        
                        <!-- Индикатор использования предмета -->
                        <TextBlock 
                            Foreground="Blue"
                            FontWeight="Bold" 
                            FontSize="18" 
                            HorizontalAlignment="Center"
                            Margin="0,5,0,10">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="Использует: {0}">
                                    <Binding Path="CurrentItemName"/>
                                </MultiBinding>
                            </TextBlock.Text>
                            <TextBlock.Visibility>
                                <Binding Path="IsUsingItem" Converter="{StaticResource BoolToVisibilityConverter}"/>
                            </TextBlock.Visibility>
                            <TextBlock.RenderTransform>
                                <TransformGroup>
                                    <ScaleTransform ScaleX="1" ScaleY="1"/>
                                    <TranslateTransform Y="0"/>
                                </TransformGroup>
                            </TextBlock.RenderTransform>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsUsingItem}" Value="True">
                                            <DataTrigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <!-- Анимация появления -->
                                                        <DoubleAnimation 
                                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)" 
                                                            From="0.5" To="1.1" Duration="0:0:0.2"/>
                                                        <DoubleAnimation 
                                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)" 
                                                            From="0.5" To="1.1" Duration="0:0:0.2"/>
                                                        <DoubleAnimation 
                                                            Storyboard.TargetProperty="Opacity" 
                                                            From="0" To="1" Duration="0:0:0.2"/>
                                                        <!-- Пульсация -->
                                                        <DoubleAnimation 
                                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)" 
                                                            From="1.1" To="1.0" Duration="0:0:0.3" BeginTime="0:0:0.2"/>
                                                        <DoubleAnimation 
                                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)" 
                                                            From="1.1" To="1.0" Duration="0:0:0.3" BeginTime="0:0:0.2"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.EnterActions>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        
                        <!-- Анимация урона -->
                        <TextBlock 
                            Text="{Binding AnimationDamage}" 
                            Foreground="Red"
                            FontWeight="Bold" 
                            FontSize="24" 
                            HorizontalAlignment="Center">
                            <TextBlock.Visibility>
                                <MultiBinding Converter="{StaticResource MultiBoolToVisibilityConverter}">
                                    <Binding Path="IsAnimating"/>
                                    <Binding Path="GameState.Settings.ShowCombatDamageNumbers"/>
                                </MultiBinding>
                            </TextBlock.Visibility>
                            <TextBlock.RenderTransform>
                                <TranslateTransform Y="0" />
                            </TextBlock.RenderTransform>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsAnimating}" Value="True">
                                            <DataTrigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation 
                                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" 
                                                            From="0" To="-50" Duration="0:0:1"/>
                                                        <DoubleAnimation 
                                                            Storyboard.TargetProperty="Opacity" 
                                                            From="1" To="0" Duration="0:0:1"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.EnterActions>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>
                    
                    <!-- Результат боя -->
                    <Border BorderBrush="{StaticResource BorderBrush}" BorderThickness="1" 
                          Margin="0,5,0,5" Padding="10" Background="{StaticResource SurfaceBrush}" 
                          CornerRadius="5" Visibility="{Binding IsBattleOver, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock Text="{Binding BattleResultMessage}" HorizontalAlignment="Center" 
                                     TextWrapping="Wrap" Margin="0,0,0,5" FontWeight="Bold" FontSize="18"/>
                                     
                            <!-- Reward message -->
                            <StackPanel Visibility="{Binding BattleWon, Converter={StaticResource BoolToVisibilityConverter}}">
                                <!-- Item rewards header -->
                                <TextBlock Text="{Binding Source='Battle.RewardItems', Converter={StaticResource TranslationConverter}}" HorizontalAlignment="Center" 
                                         Margin="0,5,0,5" FontWeight="Bold" Visibility="{Binding HasRewardItems, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                
                                <!-- Items display with wrap panel -->
                                <ItemsControl ItemsSource="{Binding GameState.BattleRewardItems}" 
                                            HorizontalAlignment="Center" Margin="0,0,0,10">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderBrush="#AAAAAA" BorderThickness="1" Margin="3" Padding="5" 
                                                  Background="#F5F5F5" CornerRadius="3" Width="70" Height="90">
                                                <StackPanel>
                                                    <Image Source="{Binding ImagePath, Converter={StaticResource ImagePathToBitmapConverter}}" Width="40" Height="40" 
                                                         HorizontalAlignment="Center" Margin="0,0,0,3"/>
                                                    <TextBlock Text="{Binding Name}" TextWrapping="Wrap" 
                                                             HorizontalAlignment="Center" FontSize="10"
                                                             TextAlignment="Center"/>
                                                </StackPanel>
                                                <Border.ToolTip>
                                                    <TextBlock Text="{Binding Description}" MaxWidth="250" 
                                                             TextWrapping="Wrap"/>
                                                </Border.ToolTip>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <!-- No items message when player won but no items received -->
                                <TextBlock Text="{Binding Source='Battle.NoRewards', Converter={StaticResource TranslationConverter}}" HorizontalAlignment="Center" 
                                         Foreground="Gray" FontStyle="Italic" Margin="0,5,0,10"
                                         Visibility="{Binding HasRewardItems, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=inverse}"/>
                            </StackPanel>
                            
                            <TextBlock Text="{Binding Source='Battle.CompleteMessage', Converter={StaticResource TranslationConverter}}" 
                                     HorizontalAlignment="Center" TextWrapping="Wrap" Margin="0,10,0,0"
                                     Foreground="#4CAF50" FontStyle="Italic"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>
            
            <!-- Enemy Characters -->
            <StackPanel Grid.Column="2" Orientation="Vertical" 
                       HorizontalAlignment="Center" VerticalAlignment="Center" 
                       Margin="20">
                <ItemsControl ItemsSource="{Binding Enemies}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border x:Name="EnemyBorder" BorderBrush="{StaticResource AccentBrush}" BorderThickness="1" 
                                  Margin="0,0,0,10" 
                                  Padding="10" CornerRadius="5">
                                <Border.Background>
                                    <SolidColorBrush Color="#FFFFFF"/>
                                </Border.Background>
                                <Border.RenderTransform>
                                    <TransformGroup>
                                        <ScaleTransform/>
                                        <SkewTransform/>
                                        <RotateTransform/>
                                        <TranslateTransform X="0" Y="0"/>
                                    </TransformGroup>
                                </Border.RenderTransform>
                                <Border.InputBindings>
                                    <MouseBinding MouseAction="LeftClick" 
                                                 Command="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=DataContext.ClickEnemyCommand}" 
                                                 CommandParameter="{Binding}"/>
                                </Border.InputBindings>
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Style.Triggers>
                                            <!-- Стиль для побежденных врагов -->
                                            <DataTrigger Binding="{Binding IsDefeated}" Value="True">
                                                <Setter Property="Opacity" Value="0.4"/>
                                                <Setter Property="Background" Value="#666666"/>
                                                <Setter Property="BorderBrush" Value="#444444"/>
                                                <Setter Property="IsEnabled" Value="False"/>
                                            </DataTrigger>
                                            <!-- Стиль для выбранного врага -->
                                            <DataTrigger Binding="{Binding Converter={StaticResource EnemyToSelectedConverter}}" Value="True">
                                                <Setter Property="BorderBrush" Value="Gold"/>
                                                <Setter Property="BorderThickness" Value="3"/>
                                            </DataTrigger>
                                            <!-- Стиль при наведении мыши (только для живых врагов) -->
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding IsDefeated}" Value="False"/>
                                                    <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=IsMouseOver}" Value="True"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Cursor" Value="Hand"/>
                                                <Setter Property="Background" Value="#FFEEEEEE"/>
                                            </MultiDataTrigger>
                                            
                                            <!-- Стиль для режима выбора цели предметов -->
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding IsDefeated}" Value="False"/>
                                                    <Condition Binding="{Binding DataContext.IsTargetSelectionMode, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="BorderBrush" Value="LimeGreen"/>
                                                <Setter Property="BorderThickness" Value="2"/>
                                                <Setter Property="Background" Value="#E8F5E8"/>
                                                <Setter Property="Cursor" Value="Hand"/>
                                            </MultiDataTrigger>
                                            
                                            <!-- Анимация атаки врага (когда этот конкретный враг атакует) -->
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <MultiBinding Converter="{StaticResource AttackingCharacterConverter}">
                                                        <Binding Path="."/>
                                                        <Binding Path="DataContext.AttackingCharacter" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                    </MultiBinding>
                                                </DataTrigger.Binding>
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard Name="EnemyAttackStoryboard">
                                                        <Storyboard>
                                                            <DoubleAnimationUsingKeyFrames 
                                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[3].(TranslateTransform.X)">
                                                                <EasingDoubleKeyFrame KeyTime="0:0:0.0" Value="0"/>
                                                                <EasingDoubleKeyFrame KeyTime="0:0:0.15" Value="-150">
                                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                                        <PowerEase Power="2" EasingMode="EaseOut"/>
                                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                                </EasingDoubleKeyFrame>
                                                                <EasingDoubleKeyFrame KeyTime="0:0:0.25" Value="-200">
                                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                                        <PowerEase Power="2" EasingMode="EaseOut"/>
                                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                                </EasingDoubleKeyFrame>
                                                                <EasingDoubleKeyFrame KeyTime="0:0:0.45" Value="0">
                                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                                        <PowerEase Power="2" EasingMode="EaseIn"/>
                                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                                </EasingDoubleKeyFrame>
                                                            </DoubleAnimationUsingKeyFrames>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="EnemyAttackStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            
                                            <!-- Анимация получения урона врагом (когда игрок атакует этого врага) -->
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <MultiBinding Converter="{StaticResource AttackingCharacterConverter}">
                                                        <Binding Path="."/>
                                                        <Binding Path="DataContext.TargetCharacter" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                    </MultiBinding>
                                                </DataTrigger.Binding>
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard Name="EnemyHitStoryboard">
                                                        <Storyboard>
                                                            <DoubleAnimation 
                                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[3].(TranslateTransform.X)" 
                                                                From="0" To="20" Duration="0:0:0.05" 
                                                                AutoReverse="True" RepeatBehavior="3x"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="EnemyHitStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            
                                            <!-- Цветовые эффекты зелий для врагов -->
                                            <!-- Эффект зелья лечения для врага - розовый -->
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding HasActiveColorEffect}" Value="True"/>
                                                    <Condition Binding="{Binding CurrentColorEffect}" Value="Healing"/>
                                                </MultiDataTrigger.Conditions>
                                                <MultiDataTrigger.EnterActions>
                                                    <BeginStoryboard Name="EnemyHealingEffectStoryboard">
                                                        <Storyboard>
                                                            <ColorAnimation 
                                                                Storyboard.TargetProperty="Background.(SolidColorBrush.Color)"
                                                                From="#FFFFFF" To="#FFB6C1" Duration="0:0:0.5" 
                                                                AutoReverse="True" RepeatBehavior="Forever"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </MultiDataTrigger.EnterActions>
                                                <MultiDataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="EnemyHealingEffectStoryboard"/>
                                                </MultiDataTrigger.ExitActions>
                                            </MultiDataTrigger>
                            
                                            <!-- Эффект зелья ярости для врага - красный -->
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding HasActiveColorEffect}" Value="True"/>
                                                    <Condition Binding="{Binding CurrentColorEffect}" Value="Rage"/>
                                                </MultiDataTrigger.Conditions>
                                                <MultiDataTrigger.EnterActions>
                                                    <BeginStoryboard Name="EnemyRageEffectStoryboard">
                                                        <Storyboard>
                                                            <ColorAnimation 
                                                                Storyboard.TargetProperty="Background.(SolidColorBrush.Color)"
                                                                From="#FFFFFF" To="#FFB6B6" Duration="0:0:0.8" 
                                                                AutoReverse="True" RepeatBehavior="Forever"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </MultiDataTrigger.EnterActions>
                                                <MultiDataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="EnemyRageEffectStoryboard"/>
                                                </MultiDataTrigger.ExitActions>
                                            </MultiDataTrigger>
                            
                                            <!-- Эффект зелья неуязвимости для врага - синий -->
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding HasActiveColorEffect}" Value="True"/>
                                                    <Condition Binding="{Binding CurrentColorEffect}" Value="Defense"/>
                                                </MultiDataTrigger.Conditions>
                                                <MultiDataTrigger.EnterActions>
                                                    <BeginStoryboard Name="EnemyDefenseEffectStoryboard">
                                                        <Storyboard>
                                                            <ColorAnimation 
                                                                Storyboard.TargetProperty="Background.(SolidColorBrush.Color)"
                                                                From="#FFFFFF" To="#B6D7FF" Duration="0:0:0.8" 
                                                                AutoReverse="True" RepeatBehavior="Forever"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </MultiDataTrigger.EnterActions>
                                                <MultiDataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="EnemyDefenseEffectStoryboard"/>
                                                </MultiDataTrigger.ExitActions>
                                            </MultiDataTrigger>
                            
                                            <!-- Эффект отравления для врага - зеленый -->
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding HasActiveColorEffect}" Value="True"/>
                                                    <Condition Binding="{Binding CurrentColorEffect}" Value="Poison"/>
                                                </MultiDataTrigger.Conditions>
                                                <MultiDataTrigger.EnterActions>
                                                    <BeginStoryboard Name="EnemyPoisonEffectStoryboard">
                                                        <Storyboard>
                                                            <ColorAnimation 
                                                                Storyboard.TargetProperty="Background.(SolidColorBrush.Color)"
                                                                From="#FFFFFF" To="#B6FFB6" Duration="0:0:0.5" 
                                                                AutoReverse="True"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </MultiDataTrigger.EnterActions>
                                                <MultiDataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="EnemyPoisonEffectStoryboard"/>
                                                </MultiDataTrigger.ExitActions>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <StackPanel>
                                    <TextBlock Text="{Binding TranslatedName}" FontSize="16" FontWeight="Bold" 
                                             HorizontalAlignment="Center" Margin="0,0,0,5">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsDefeated}" Value="True">
                                                        <Setter Property="Foreground" Value="#888888"/>
                                                        <Setter Property="Text" Value="{Binding TranslatedName, StringFormat=\{0\} (Побежден)}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <Grid>
                                        <Image Source="{Binding ImagePath, Converter={StaticResource ImagePathToBitmapConverter}}" Width="100" Height="100" Margin="0,0,0,5">
                                            <Image.Style>
                                                <Style TargetType="Image">
                                                    <Style.Triggers>
                                                        <!-- Серый фильтр для побежденных врагов -->
                                                        <DataTrigger Binding="{Binding IsDefeated}" Value="True">
                                                            <Setter Property="Effect">
                                                                <Setter.Value>
                                                                    <BlurEffect Radius="1"/>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Setter Property="Opacity" Value="0.3"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Image.Style>
                                        </Image>
                                    </Grid>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="{Binding Source='Battle.Health', Converter={StaticResource TranslationConverter}}" Margin="0,0,5,2"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1" Margin="0,0,0,2">
                                            <TextBlock.Text>
                                                <MultiBinding StringFormat="{}{0}/{1}">
                                                    <Binding Path="CurrentHealth" Mode="OneWay" />
                                                    <Binding Path="MaxHealth" Mode="OneWay" />
                                                </MultiBinding>
                                            </TextBlock.Text>
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsDefeated}" Value="True">
                                                            <Setter Property="Foreground" Value="#888888"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        
                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="{Binding Source='Battle.Attack', Converter={StaticResource TranslationConverter}}" Margin="0,0,5,2"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TotalAttack}" Margin="0,0,0,2">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsDefeated}" Value="True">
                                                            <Setter Property="Foreground" Value="#888888"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        
                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="{Binding Source='Battle.Defense', Converter={StaticResource TranslationConverter}}" Margin="0,0,5,2"/>
                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TotalDefense}" Margin="0,0,0,2">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsDefeated}" Value="True">
                                                            <Setter Property="Foreground" Value="#888888"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
            
            <!-- Battle log panel -->
            <Border Grid.Column="0" Grid.ColumnSpan="3" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1"
                   Background="{StaticResource BackgroundBrush}" Margin="10" Padding="10"
                   CornerRadius="5" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                   Width="200" Height="150" Opacity="0.8">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding BattleLog}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" TextWrapping="Wrap" Margin="0,0,0,5"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
        </Grid>
        
        <!-- Action Bar -->
        <Border Grid.Row="2" Background="{StaticResource BackgroundBrush}" BorderBrush="{StaticResource BorderBrush}" 
              BorderThickness="0,1,0,0" Padding="20,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Выбор целей - только показывать если несколько врагов и ход игрока -->
                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                    <StackPanel.Visibility>
                        <MultiBinding Converter="{StaticResource MultiBoolToVisibilityConverter}">
                            <Binding Path="IsPlayerTurn"/>
                            <Binding Path="ShowEnemySelection"/>
                        </MultiBinding>
                    </StackPanel.Visibility>
                    <TextBlock Text="{Binding Source='Battle.SelectTarget', Converter={StaticResource TranslationConverter}}" Margin="0,0,0,5"/>
                    <ComboBox ItemsSource="{Binding Enemies}" 
                            SelectedItem="{Binding SelectedEnemy}" 
                            DisplayMemberPath="TranslatedName"
                            Width="150">
                        <ComboBox.ItemContainerStyle>
                            <Style TargetType="ComboBoxItem">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsDefeated}" Value="True">
                                        <Setter Property="IsEnabled" Value="False"/>
                                        <Setter Property="Foreground" Value="Gray"/>
                                        <Setter Property="FontStyle" Value="Italic"/>
                                        <Setter Property="ContentStringFormat" Value="{}{0} ({Binding Source='Battle.Defeated', Converter={StaticResource TranslationConverter}})"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ComboBox.ItemContainerStyle>
                    </ComboBox>
                </StackPanel>
                
                <!-- Панель быстрого доступа для предметов -->
                <StackPanel Grid.Column="1" VerticalAlignment="Center" 
                         Visibility="{Binding IsPlayerTurn, Converter={StaticResource BoolToVisibilityConverter}}"
                         HorizontalAlignment="Center">
                    <TextBlock Text="Быстрый доступ" Margin="0,0,0,5" HorizontalAlignment="Center" FontWeight="Bold"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <!-- Слот быстрого доступа 0 -->
                        <Border Width="50" Height="50" BorderBrush="#373737" BorderThickness="2" 
                               Background="#F0F0F0" Margin="2" CornerRadius="3" Cursor="Hand"
                               ToolTip="{Binding GameState.Inventory.QuickItems[0].Description}">
                            <Border.InputBindings>
                                <MouseBinding MouseAction="LeftClick" 
                                            Command="{Binding UseItemCommand}" 
                                            CommandParameter="{Binding GameState.Inventory.QuickItems[0]}"/>
                            </Border.InputBindings>
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[0]}" Value="{x:Null}">
                                            <Setter Property="Background" Value="#E0E0E0"/>
                                            <Setter Property="Cursor" Value="Arrow"/>
                                        </DataTrigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#E8E8E8"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <Grid>
                                <!-- Изображение предмета -->
                                <Image Source="{Binding GameState.Inventory.QuickItems[0].Icon}" 
                                      Width="40" Height="40" Stretch="Uniform">
                                    <Image.Style>
                                        <Style TargetType="Image">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[0]}" Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Image.Style>
                                </Image>
                                <!-- Количество предметов -->
                                <TextBlock Text="{Binding GameState.Inventory.QuickItems[0].StackSize}" 
                                          FontSize="10" FontWeight="Bold" Foreground="White"
                                          HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                          Margin="0,0,2,2">
                                    <TextBlock.Effect>
                                        <DropShadowEffect ShadowDepth="1" Color="Black" Opacity="0.8"/>
                                    </TextBlock.Effect>
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[0]}" Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[0].StackSize}" Value="1">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <!-- Подсказка для пустого слота -->
                                <TextBlock Text="1" FontSize="20" FontWeight="Bold" Foreground="#999999"
                                          HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[0]}" Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[0]}" Value="{x:Static system:DBNull.Value}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>
                        </Border>
                        
                        <!-- Слот быстрого доступа 1 -->
                        <Border Width="50" Height="50" BorderBrush="#373737" BorderThickness="2" 
                               Background="#F0F0F0" Margin="2" CornerRadius="3" Cursor="Hand"
                               ToolTip="{Binding GameState.Inventory.QuickItems[1].Description}">
                            <Border.InputBindings>
                                <MouseBinding MouseAction="LeftClick" 
                                            Command="{Binding UseItemCommand}" 
                                            CommandParameter="{Binding GameState.Inventory.QuickItems[1]}"/>
                            </Border.InputBindings>
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[1]}" Value="{x:Null}">
                                            <Setter Property="Background" Value="#E0E0E0"/>
                                            <Setter Property="Cursor" Value="Arrow"/>
                                        </DataTrigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#E8E8E8"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <Grid>
                                <!-- Изображение предмета -->
                                <Image Source="{Binding GameState.Inventory.QuickItems[1].Icon}" 
                                      Width="40" Height="40" Stretch="Uniform">
                                    <Image.Style>
                                        <Style TargetType="Image">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[1]}" Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Image.Style>
                                </Image>
                                <!-- Количество предметов -->
                                <TextBlock Text="{Binding GameState.Inventory.QuickItems[1].StackSize}" 
                                          FontSize="10" FontWeight="Bold" Foreground="White"
                                          HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                          Margin="0,0,2,2">
                                    <TextBlock.Effect>
                                        <DropShadowEffect ShadowDepth="1" Color="Black" Opacity="0.8"/>
                                    </TextBlock.Effect>
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[1]}" Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[1].StackSize}" Value="1">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <!-- Подсказка для пустого слота -->
                                <TextBlock Text="2" FontSize="20" FontWeight="Bold" Foreground="#999999"
                                          HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[1]}" Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding GameState.Inventory.QuickItems[1]}" Value="{x:Static system:DBNull.Value}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>
                        </Border>
                    </StackPanel>
                </StackPanel>
                
                <!-- Action Buttons -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button x:Name="AttackButton" 
                            Command="{Binding AttackCommand}"
                            Width="100" Height="40" Margin="5,0" 
                            Content="{Binding Source='Battle.Attack', Converter={StaticResource TranslationConverter}}"
                            Visibility="{Binding IsPlayerTurn, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    
                    <!-- Force End Turn button - only visible when not player turn and battle not over -->
                    <Button x:Name="ForceEndTurnButton" 
                            Command="{Binding ForceEndTurnCommand}"
                            Width="120" Height="40" Margin="5,0" 
                            Content="Завершить ход"
                            Background="#FF5722" Foreground="White"
                            FontSize="11" FontWeight="Bold"
                            ToolTip="Принудительно завершить текущий ход (используйте при зависании)">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsPlayerTurn}" Value="False"/>
                                            <Condition Binding="{Binding IsBattleOver}" Value="False"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                    
                    <!-- Complete Battle button when battle is over -->
                    <Button x:Name="CompleteButton" Content="{Binding Source='Battle.Complete', Converter={StaticResource TranslationConverter}}" 
                            Command="{Binding EndBattleCommand}"
                            Width="150" Height="45" Margin="5,0" 
                            Background="#4CAF50" Foreground="White" 
                            FontWeight="Bold" FontSize="14">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsBattleOver}" Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <!-- Add hover effect and animation to draw attention -->
                        <Button.Effect>
                            <DropShadowEffect ShadowDepth="2" Color="Gold" Opacity="0.6" BlurRadius="10"/>
                        </Button.Effect>
                        <Button.Triggers>
                            <EventTrigger RoutedEvent="Button.Loaded">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation 
                                            Storyboard.TargetProperty="Opacity" 
                                            From="0.7" To="1.0" Duration="0:0:0.8"
                                            AutoReverse="True" RepeatBehavior="Forever"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </Button.Triggers>
                    </Button>
                    
                    <Button Content="{Binding Source='Battle.NextTurn', Converter={StaticResource TranslationConverter}}" Command="{Binding NextTurnCommand}" 
                            Width="100" Height="40" Margin="5,0" 
                            Visibility="{Binding CanAdvanceTurn, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
